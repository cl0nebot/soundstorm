#
# Production services configuration for Soundstorm. Adds the `redis` and
# `sidekiq` services, and disables `mailcatcher`. All services in
# production are created using released images from the registry, which
# have been ostensibly verified as working.

version: '3'
services:
  # Use CloudWatch logs in the database
  db:
    logging:
      driver: awslogs
      options:
        awslogs-group: soundstorm_db
        awslogs-region: us-east-1
        awslogs-stream-prefix: db

  # Redis stores the ephemeral Rails/HTTP cache and Sidekiq job queue
  redis:
    image: redis
    volumes:
      - redis:/data
    logging:
      driver: awslogs
      options:
        awslogs-group: soundstorm
        awslogs-region: us-east-1
        awslogs-stream-prefix: redis


  # Speed up application deployment by launching an image rather than
  # building a full container, such as in development. Dependencies are
  # also preloaded onto the image and the entrypoint script for
  # installing deps is disabled. Migrations still occur in the
  # ENTRYPOINT, however, so as not to depend the entire app on the
  # database being fully up.
  web:
    build:
      context: .
      args:
        - RAILS_ENV=production
    image: tubbo/soundstorm
    volumes:
      - static:/srv/public
    expose:
      - 3000
    depends_on:
      - db
      - redis
    env_file:
      - .env.production
      - .env.secrets
    logging:
      driver: awslogs
      options:
        awslogs-group: soundstorm
        awslogs-region: us-east-1
        awslogs-stream-prefix: web


  # Lock down Elasticsearch clients to other Docker hosts
  search:
    expose:
      - 9200
    logging:
      driver: awslogs
      options:
        awslogs-group: soundstorm
        awslogs-region: us-east-1
        awslogs-stream-prefix: search

  # Set up the database asynchronously to the main production container.
  # migrations: &task
  #   image: tubbo/soundstorm
  #   command: bin/rails db:update
  #   depends_on:
  #     - db
  #     - web
  #   env_file:
  #     - .env.production
  #     - .env.secrets
  #   logging:
  #     driver: awslogs
  #     options:
  #       awslogs-group: soundstorm_tasks
  #       awslogs-region: us-east-1
  #       awslogs-stream-prefix: soundstorm


  # Precompile static assets
  # assets:
  #   <<: *task
  #   command: bin/rails assets:precompile

  # Background job processor for the application, running background
  # jobs within the Rails context. This container will always use the
  # same image as +web+, ensuring that both services are launched with
  # the same codebase.
  queue:
    image: tubbo/soundstorm
    command: bin/bundle exec sidekiq -C config/sidekiq.yml
    depends_on:
      - db
      - redis
      - web
    env_file:
      - .env.production
      - .env.secrets
    logging:
      driver: awslogs
      options:
        awslogs-group: soundstorm
        awslogs-region: us-east-1
        awslogs-stream-prefix: queue

  # Outbound HTTP server
  httpd:
    image: tubbo/soundstorm
    command: caddy -agree
    ports:
      - "80:80"
      - "443:443"
    links:
      - web
    logging:
      driver: awslogs
      options:
        awslogs-group: soundstorm
        awslogs-region: us-east-1
        awslogs-stream-prefix: httpd


volumes:
  redis:
  static:
