#!/bin/bash
#
# Run commands for the Soundstorm application within a Docker container.

case "$1" in
  # build containers and set up the database
  init)
    export RAILS_PORT="3$((RANDOM%1000))"
    echo "RAILS_PORT=$RAILS_PORT" > "$PWD"/.env
    PUMA_DEV="$HOME/.puma-dev"
    if [[ -d "$PUMA_DEV" ]]; then
      if [[ -x "$PUMA_DEV/soundstorm" ]]; then
        echo "$RAILS_PORT" > "$PUMA_DEV/soundstorm"
      fi
    fi
    docker-compose run web bin/rails tmp:clear log:clear
    ;;
  # view logs for a given service, default is "web"
  logs)
    if [ -z "$2" ]; then
      service="web"
    else
      service="$2"
    fi

    docker-compose logs -f "$service"
    ;;
  # start all containers
  start)
    docker-compose up -d

    if [[ -f "$PUMA_DEV/soundstorm" ]]; then
      echo "Soundstorm has started at https://soundstorm.test"
    else
      echo "Soundstorm has started at http://localhost.test:$RAILS_PORT"
    fi
    ;;
  # stop and remove running containers
  stop)
    docker-compose down
    echo "Soundstorm has shut down"
    ;;
  # restart the web container
  restart)
    docker-compose restart web
    echo "Soundstorm has restarted"
    ;;
  # build and ship the production image to the registry
  ship)
    RAILS_ENV="production" docker-compose build web &&
      docker-compose push web
    ;;
  "")
    echo "Usage: bin/soundstorm [COMMAND]"
    echo
    echo "Commands:"
    echo "  init            Initialize your local environment to run Soundstorm"
    echo "  logs [SERVICE]  View logs for a given service. (default: web)"
    echo "  start           Start the application"
    echo "  stop            Stop the application"
    echo "  restart         Restart the web server"
    echo "  ship            Publish a new version of Soundstorm"
    echo
    echo "If a command is unknown, it is delegated to bin/rails on the web container"
    echo "To deploy to production, prefix commands with RAILS_ENV=production"
    ;;
  # delegate task commands to ./bin/rails
  *)
    docker-compose run web bin/rails "$*"
    ;;
esac
