#!/usr/local/bin/zsh
#
# Run commands for the Soundstorm application within a Docker container.


case "$1" in
  init)     # build containers and set up the database
    export RAILS_PORT="3$[${RANDOM}%1000]"
    echo "RAILS_PORT=$RAILS_PORT" > $PWD/.env
    echo "$RAILS_PORT" > $HOME/.puma-dev/soundstorm
    docker-compose run web bin/rails db:setup
    ;;
  logs)     # view web application logs
    docker-compose logs -f web
    ;;
  start)    # start all containers
    docker-compose up -d
    echo "Soundstorm has started at https://soundstorm.test"
    ;;
  stop)     # stop and remove running containers
    docker-compose down
    echo "Soundstorm has shut down"
    ;;
  restart)  # restart the web container
    docker-compose restart web
    echo "Soundstorm has restarted"
    ;;
  build)
    docker-compose build web
    ;;
  *)        # delegate unknown commands to ./bin/rails
    docker-compose run web ./bin/rails $*
    ;;
esac
